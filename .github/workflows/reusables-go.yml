---
name: Reusable Go Checks

'on':
  workflow_call:
    inputs:
      go-version:
        description: "Go version to use"
        type: string
        default: "stable"
      working-directory:
        description: "Directory where Go code is located"
        type: string
        default: "."
    secrets:
      CHECKER_TOKEN:
        description: "Token for API operations"
        required: true
    outputs:
      go-summary:
        description: "Summary of Go checks"
        value: ${{ jobs.check-go-code.outputs.summary }}
      go-status:
        description: "Status of Go checks"
        value: ${{ jobs.check-go-code.outputs.status }}

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  DEFAULT_GOLANGCI_CONFIG: |
    linters:
      enable:
        - errcheck
        - gosimple
        - govet
        - ineffassign
        - staticcheck
        - unused
    run:
      timeout: 5m

jobs:
  check-go-code:
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.outcome.outputs.summary }}
      status: ${{ steps.outcome.outputs.status }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: false

      - name: Set up default golangci-lint config
        shell: bash
        run: |
          WORKDIR="${{ inputs.working-directory }}"
          CONFIG_FILES="golangci.yml golangci.yaml golangci.toml"
          NO_CONFIG=true
          for f in $CONFIG_FILES; do
            if [ -f "$WORKDIR/.$f" ]; then
              NO_CONFIG=false
              break
            fi
          done
          if $NO_CONFIG; then
            echo "$DEFAULT_GOLANGCI_CONFIG" > "$WORKDIR/.golangci.yml"
          fi

      - name: Check go mod tidy
        id: tidy
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        continue-on-error: true
        run: |
          go mod tidy
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::go.mod/go.sum are dirty, please run 'go mod tidy'"
            exit 1
          fi

      - name: Install gotestsum
        shell: bash
        run: go install gotest.tools/gotestsum@latest

      - name: Run golangci-lint
        id: lint
        uses: golangci/golangci-lint-action@v6
        continue-on-error: true
        with:
          version: latest
          working-directory: ${{ inputs.working-directory }}
          args: --timeout=5m

      - name: Run Tests (Race Detector)
        id: test
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        continue-on-error: true
        run: |
          GOTESTSUM_BIN="$(go env GOPATH)/bin/gotestsum"
          $GOTESTSUM_BIN --junitfile test-results.xml -- -race ./...

      - name: Publish Test Results
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: "**/test-results.xml"
          check_name: "Go Test Results"

      - name: Build Check (Dry Run)
        id: build
        shell: bash
        working-directory: ${{ inputs.working-directory }}
        continue-on-error: true
        run: go build -v ./...

      - name: Set Go Checks Outcome
        id: outcome
        if: always()
        shell: bash
        run: |
          .github/scripts/go-check-outcome.sh \
            "${{ steps.tidy.outcome }}" \
            "${{ steps.lint.outcome }}" \
            "${{ steps.test.outcome }}" \
            "${{ steps.build.outcome }}"
