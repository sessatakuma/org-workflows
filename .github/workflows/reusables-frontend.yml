name: 'Frontend Code Quality Checks'

on:
  workflow_call:
    inputs:
      node-version:
        description: 'The Node.js version to use'
        required: false
        type: string
        default: '20'
    secrets:
      CHECKER_TOKEN:
        description: 'The GITHUB_TOKEN passed from the caller'
        required: true
    outputs:
      prettier-status:
        description: "The status of the Prettier formatting check."
        value: ${{ jobs.check-prettier.outputs.status }}
      prettier-summary:
        description: "A summary of the Prettier formatting check."
        value: ${{ jobs.check-prettier.outputs.summary }}
      eslint-status:
        description: "The status of the ESLint check."
        value: ${{ jobs.check-eslint.outputs.status }}
      eslint-summary:
        description: "A summary of the ESLint check."
        value: ${{ jobs.check-eslint.outputs.summary }}

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  DEFAULT_PRETTIER_CONFIG: |
    {
      "semi": true,
      "singleQuote": true,
      "trailingComma": "es5",
      "tabWidth": 2,
      "useTabs": false,
      "arrowParens": "always",
      "printWidth": 80
    }
  DEFAULT_ESLINT_CONFIG: |
    import js from "@eslint/js";
    import globals from "globals";

    export default [
        js.configs.recommended,
        {
            files: ["**/*.{js,mjs,cjs,jsx}"],

            languageOptions: {
                ecmaVersion: "latest",
                sourceType: "module",
                globals: {
                    ...globals.browser,
                    ...globals.node,
                    ...globals.es2021
                },
                parserOptions: {
                    ecmaFeatures: {
                        jsx: true
                    }
                }
            },
            rules: {
                "no-console": "warn",
                "no-unused-vars": "warn",
                "no-var": "error"
            },
        },
        {
            ignores: [
                "dist/**",
                "node_modules/**",
                "build/**"
            ]
        }
    ];


jobs:
  check-prettier:
    name: 'Check Prettier Formatting'
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
      summary: ${{ steps.check.outputs.summary }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Set up default Prettier config
        run: |
          if [ ! -f ".prettierrc" ] && [ ! -f ".prettierrc.json" ] && [ ! -f "prettier.config.js" ]; then
            echo '${{ env.DEFAULT_PRETTIER_CONFIG }}' > .prettierrc.json
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install Dev Dependencies
        run: |
          npm install --only=dev

      - name: Ensure Prettier is installed
        run: |
          npm list prettier > /dev/null 2>&1 || npm install --save-dev prettier

      - name: Check Prettier Formatter
        id: check
        run: |
          echo "Running prettier format check..."
          set +e  # Don't exit on prettier failure
          npx prettier --check ./src 2>&1 | tee prettier_output.txt
          PRETTIER_EXIT_CODE=$?
          set -e

          if [ $PRETTIER_EXIT_CODE -ne 0 ]; then
            # Extract filenames from prettier output and generate annotations
            grep -E "^\S+\.(js|jsx|ts|tsx|json|css|scss|md|yaml|yml)$" prettier_output.txt | while read -r file; do
              if [ -f "$file" ]; then
                echo "::error title=Prettier Formatting,file=${file},line=1,col=1::File needs formatting. Run 'npm run format' to fix."
              fi
            done
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "summary=❌ **Prettier:** Formatting issues found. Please review the annotations above." >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "summary=✅ **Prettier:** All files are properly formatted." >> $GITHUB_OUTPUT
          fi

  check-eslint:
    name: 'Check ESLint'
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
      summary: ${{ steps.check.outputs.summary }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Set up default ESLint config
        run: |
          if [ ! -f ".eslintrc" ] && [ ! -f ".eslintrc.json" ] && [ ! -f ".eslintrc.js" ] && [ ! -f "eslint.config.js" ] && [ ! -f "eslint.config.mjs" ]; then
            echo '${{ env.DEFAULT_ESLINT_CONFIG }}' > eslint.config.mjs
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install Dev Dependencies
        run: |
          npm install --only=dev

      - name: Ensure ESLint is installed
        run: |
          npm list eslint > /dev/null 2>&1 || npm install --save-dev eslint
          npm list globals > /dev/null 2>&1 || npm install --save-dev globals

      - name: Check ESLint
        id: check
        run: |
          echo "Running ESLint with GitHub annotations..."
          set +e  # Don't exit on ESLint failure
          npx eslint ./src --format json --output-file eslint_output.json
          ESLINT_EXIT_CODE=$?

          # Parse ESLint JSON output and generate GitHub annotations
          if [ -f eslint_output.json ]; then
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('eslint_output.json', 'utf8'));
              
              let hasErrors = false;
              results.forEach(result => {
                result.messages.forEach(message => {
                  const file = result.filePath.replace(process.cwd() + '/', '');
                  const line = message.line || 1;
                  const column = message.column || 1;
                  const severity = message.severity === 2 ? 'error' : 'warning';
                  const ruleId = message.ruleId ? \` (\${message.ruleId})\` : '';
                  const messageText = message.message;
                  
                  if (message.severity === 2) hasErrors = true;
                  
                  console.log(\`::\${severity} title=ESLint\${ruleId},file=\${file},line=\${line},col=\${column}::\${file}:\${line}:\${column}: \${messageText}\`);
                });
              });
            "
          fi

          if [ $ESLINT_EXIT_CODE -ne 0 ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "summary=❌ **ESLint:** Issues found. Please review the annotations above." >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "summary=✅ **ESLint:** No issues found." >> $GITHUB_OUTPUT
          fi